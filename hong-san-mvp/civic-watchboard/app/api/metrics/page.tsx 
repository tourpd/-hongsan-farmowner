// app/metrics/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";

type RankingRow = {
  policy: string;
  cnt: number;
  total_budget: number;
  score: number;
  strength: number; // 0~100
};

type CardMonthRow = {
  policy: string;
  period: string; // YYYY-MM
  cnt: number | string;
};

type ApiPayload = {
  ok: boolean;
  generatedAt?: string;
  data?: {
    ranking?: any[];
    cardMonth?: any[];
  };
};

function safeNumber(v: unknown, fallback = 0): number {
  const n =
    typeof v === "number"
      ? v
      : typeof v === "string"
        ? Number(v.replace(/,/g, ""))
        : NaN;
  return Number.isFinite(n) ? n : fallback;
}

function formatKRWShort(n: number): string {
  // 1억 = 100,000,000
  const eok = n / 100_000_000;
  if (eok >= 1) return `${eok.toFixed(1)}억`;
  const man = n / 10_000;
  if (man >= 1) return `${Math.round(man).toLocaleString()}만`;
  return `${Math.round(n).toLocaleString()}원`;
}

function formatKST(isoString: string): string {
  // 서버가 Z(UTC)로 내려도 KST로 보여주기
  const d = new Date(isoString);
  if (Number.isNaN(d.getTime())) return isoString;
  return d.toLocaleString("ko-KR", { timeZone: "Asia/Seoul" });
}

export default function MetricsPage() {
  const [ranking, setRanking] = useState<RankingRow[]>([]);
  const [month, setMonth] = useState<CardMonthRow[]>([]);
  const [selected, setSelected] = useState<string | null>(null);
  const [limit, setLimit] = useState(10);
  const [q, setQ] = useState("");
  const [generatedAt, setGeneratedAt] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);

  useEffect(() => {
    let alive = true;

    (async () => {
      try {
        setLoading(true);
        setErr(null);

        const res = await fetch("/api/metrics", { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const j = (await res.json()) as ApiPayload;

        if (!alive) return;

        const rawRanking = (j?.data?.ranking ?? []) as any[];
        const rawMonth = (j?.data?.cardMonth ?? []) as any[];

        const normalizedRanking: RankingRow[] = rawRanking.map((x) => ({
          policy: String(x?.policy ?? ""),
          cnt: safeNumber(x?.cnt, 0),
          total_budget: safeNumber(x?.total_budget, 0),
          score: safeNumber(x?.score, 0),
          strength: Math.max(0, Math.min(100, safeNumber(x?.strength, 0))),
        }));

        const normalizedMonth: CardMonthRow[] = rawMonth.map((x) => ({
          policy: String(x?.policy ?? ""),
          period: String(x?.period ?? ""),
          cnt: safeNumber(x?.cnt, 0),
        }));

        setRanking(normalizedRanking);
        setMonth(normalizedMonth);
        setGeneratedAt(j?.generatedAt ? String(j.generatedAt) : null);
      } catch (e: any) {
        if (!alive) return;
        setErr(e?.message ? String(e.message) : "metrics fetch failed");
      } finally {
        if (!alive) return;
        setLoading(false);
      }
    })();

    return () => {
      alive = false;
    };
  }, []);

  const filtered = useMemo(() => {
    const qq = q.trim();
    const base = qq ? ranking.filter((r) => r.policy.includes(qq)) : ranking;
    return base.slice(0, limit);
  }, [ranking, q, limit]);

  const monthRows = useMemo(() => {
    if (!selected) return [];
    return month
      .filter((m) => m.policy === selected)
      .map((m) => ({ ...m, cnt: safeNumber(m.cnt, 0) }))
      .sort((a, b) => a.period.localeCompare(b.period));
  }, [month, selected]);

  const maxMonthCnt = useMemo(() => {
    let max = 0;
    for (const m of monthRows) max = Math.max(max, safeNumber(m.cnt, 0));
    return max || 1;
  }, [monthRows]);

  return (
    <main className="p-8 max-w-5xl mx-auto space-y-6">
      <header className="flex items-start justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">정책 랭킹 (정책카드 TOP)</h1>
          <p className="text-sm text-gray-600 mt-1">
            “이 시장은 4년간 무엇을 반복적으로 발주/집행했는가?”를 한 장에서
            보여주는 화면입니다.
            <br />
            <span className="text-gray-500">
              (현재는 더미/시범 데이터이지만, 구조는 실데이터로 그대로 확장됩니다.)
            </span>
          </p>
        </div>

        <div className="text-xs text-gray-500 whitespace-nowrap pt-1">
          {generatedAt ? `업데이트: ${formatKST(generatedAt)}` : ""}
        </div>
      </header>

      <div className="flex gap-2">
        <input
          className="border rounded px-3 py-2 flex-1"
          placeholder="정책카드 검색 (예: 대곡역, 교통, 공원...)"
          value={q}
          onChange={(e) => setQ(e.target.value)}
        />

        <select
          className="border rounded px-2"
          value={limit}
          onChange={(e) => setLimit(Number(e.target.value))}
        >
          <option value={5}>TOP 5</option>
          <option value={10}>TOP 10</option>
          <option value={20}>20개</option>
        </select>
      </div>

      {loading && (
        <div className="text-sm text-gray-600 border rounded p-4">로딩 중…</div>
      )}

      {err && (
        <div className="text-sm text-red-600 border border-red-200 bg-red-50 rounded p-4">
          /api/metrics 호출 실패: {err}
          <div className="text-xs text-red-500 mt-2">
            (서버가 떠 있는지, /api/metrics가 JSON을 반환하는지 확인해 주세요.)
          </div>
        </div>
      )}

      {!loading && !err && (
        <section className="space-y-4">
          {filtered.length === 0 && (
            <div className="text-sm text-gray-600 border rounded p-4">
              검색 결과가 없습니다.
            </div>
          )}

          {filtered.map((r, i) => {
            const isOpen = selected === r.policy;

            return (
              <div key={r.policy} className="border rounded p-4 space-y-2">
                <div className="flex justify-between items-center gap-3">
                  <div className="min-w-0">
                    <div className="text-sm text-gray-500">#{i + 1}</div>
                    <div className="font-semibold truncate">{r.policy}</div>
                    <div className="text-sm text-gray-500 mt-1">
                      총 {r.cnt.toLocaleString()}건 · 추정 예산{" "}
                      {formatKRWShort(r.total_budget)}
                    </div>
                  </div>

                  <button
                    type="button"
                    className="text-sm border rounded px-3 py-2 whitespace-nowrap"
                    onClick={() => setSelected(isOpen ? null : r.policy)}
                    aria-expanded={isOpen}
                  >
                    {isOpen ? "자세히 ▲" : "자세히 ▼"}
                  </button>
                </div>

                <div className="h-2 bg-gray-200 rounded">
                  <div
                    className="h-2 bg-black rounded"
                    style={{ width: `${r.strength}%` }}
                  />
                </div>

                <div className="text-xs text-gray-500">
                  랭킹 강도: {r.strength}%
                </div>

                {isOpen && (
                  <div className="pt-3 space-y-2">
                    <div className="flex items-center justify-between">
                      <div className="font-semibold text-sm">
                        월별 추이(해당 정책)
                      </div>
                      <a
                        className="text-xs text-blue-600 hover:underline"
                        href="/dashboard"
                      >
                        근거 보기(대시보드)
                      </a>
                    </div>

                    <div className="space-y-2">
                      {monthRows.length === 0 && (
                        <div className="text-sm text-gray-500">
                          월별 데이터가 없습니다.
                        </div>
                      )}

                      {monthRows.map((m) => {
                        const cnt = safeNumber(m.cnt, 0);
                        const width = Math.round((cnt / maxMonthCnt) * 100);

                        return (
                          <div key={m.period} className="flex items-center gap-3">
                            <div className="w-24 text-xs text-gray-700">
                              {m.period}
                            </div>

                            <div className="flex-1 h-2 bg-gray-200 rounded">
                              <div
                                className="h-2 bg-black rounded"
                                style={{ width: `${width}%` }}
                              />
                            </div>

                            <div className="w-8 text-right text-xs text-gray-700">
                              {cnt}
                            </div>
                          </div>
                        );
                      })}
                    </div>

                    <div className="text-xs text-gray-500 border rounded p-3 bg-gray-50">
                      * 월별 막대는 “해당 정책의 월별 최댓값”을 100%로 정규화했습니다.
                      (월별 강도 비교용)
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </section>
      )}
    </main>
  );
}